const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/resourceUtils-D32WqdA1.js","assets/index-szNj1aqA.js","assets/index-4rsQkLC1.css","assets/geometryServiceUtils-DwLfpNW2.js"])))=>i.map(i=>d[i]);
import{g6 as Q,bZ as E,g7 as X,ac as Y,a7 as w,g8 as ee,g9 as ae,ga as te,gb as _,bN as oe,bn as re,bo as ne,gc as l,gd as b,ge as f,gf as se,ej as ie,gg as ce,ef as le,bb as pe,eg as ue,b$ as h,gh as C,gi as de,gj as fe}from"./index-szNj1aqA.js";import{r as D,t as V,i as me}from"./saveUtils-DoolE4qs.js";import{m as we,b as he,d as ye}from"./basemapUtils-DFXVvlSe.js";import{getSiblingOfSameTypeI as ge,contentToBlob as g}from"./resourceUtils-D32WqdA1.js";async function M(a,e,t){const o=await j(a,e,t);await L(o,e,t)}async function Ze(a,e,t,o,r){const s=await j(t,o,r);await a.update({data:e}),await L(s,o,r)}async function j(a,e,t){if(!(e!=null&&e.resources))return;const o=e.portalItem===a.portalItem?new Set(a.paths):new Set;a.paths.length=0,a.portalItem=e.portalItem;const r=new Set(e.resources.toKeep.map(n=>n.resource.path)),s=new Set,i=[];r.forEach(n=>{o.delete(n),a.paths.push(n)});const c=[],u=[],p=[];for(const n of e.resources.toUpdate)if(o.delete(n.resource.path),r.has(n.resource.path)||s.has(n.resource.path)){const{resource:d,content:Z,finish:R}=n,y=ge(d,Q());a.paths.push(y.path),c.push({resource:y,content:await g(Z),compress:n.compress}),R&&p.push(()=>R(y))}else{a.paths.push(n.resource.path),u.push({resource:n.resource,content:await g(n.content),compress:n.compress});const d=n.finish;d&&p.push(()=>d(n.resource)),s.add(n.resource.path)}for(const n of e.resources.toAdd)if(a.paths.push(n.resource.path),o.has(n.resource.path))o.delete(n.resource.path);else{c.push({resource:n.resource,content:await g(n.content),compress:n.compress});const d=n.finish;d&&p.push(()=>d(n.resource))}if(c.length||u.length){const{addOrUpdateResources:n}=await E(()=>import("./resourceUtils-D32WqdA1.js"),__vite__mapDeps([0,1,2]));await n(e.portalItem,c,"add",t),await n(e.portalItem,u,"update",t)}if(p.forEach(n=>n()),i.length===0)return o;const m=await X(i);if(Y(t),m.length>0)throw new w("save:resources","Failed to save one or more resources",{errors:m});return o}async function L(a,e,t){if(!a||!e.portalItem)return;const o=[];for(const r of a){const s=e.portalItem.resourceFromPath(r);o.push(s.portalItem.removeResource(s,t))}await ee(o)}const _e=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map(a=>a.toLowerCase());async function be(a,e,t){t??(t={}),ve(a,e),await _(()=>!e.updatingFromView),await e.load(),await G(e),await D(e),await N(a,e);const o=e.portalItem,{json:r,jsonContext:s}=await I(e,o,a.origin);return V(s,{errorName:`${a.name}:save`},t),await x(e,o),await Ke(a,e,o,r,s),await Promise.all([e.updateItemThumbnail(),M(e.resourceReferences,s)]),o}async function I(a,e,t){const o=ae(e,t,!0),r=a.write({},o);return await Promise.all(o.resources.pendingOperations),{json:r,jsonContext:o}}async function Ie(a,e,t,o){o??(o={});const r=Re(a,t);await _(()=>!e.updatingFromView),await e.load(),await G(e),await D(e),await N(a,e);const{json:s,jsonContext:i}=await I(e,r,a.origin);V(i,{errorName:`${a.name}:save`},o),await Pe(e,r);const c=e.getThumbnailState();return await $e(a,e,r,s,i,o)&&(e.resourceReferences.portalItem=r),e.restoreThumbnailFromState(c),await Promise.all([e.updateItemThumbnail(),M(e.resourceReferences,i)]),r}function ve(a,e){if(!e.portalItem)throw new w(`${a.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");k(a,e.portalItem)}function k(a,e){if(e.type!==a.itemType)throw new w(`${a.name}:portal-item-wrong-type`,`Portal item needs to have type "${a.itemType}"`)}async function N(a,e){var o;if(a.name==="linkchart")return;if(!((o=e.basemap)!=null&&o.baseLayers.length))throw new w(`${a.name}:save`,"Map does not have a valid basemap with a base layer.");let t=null;if(await _(()=>{const r=ye(e.initialViewProperties,e.basemap);return t=r.spatialReference,!r.updating}),!oe(t,e.initialViewProperties.spatialReference))throw new w(`${a.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:e.initialViewProperties.spatialReference,actual:t})}function Re(a,e){let t=re.from(e);return t.id&&(t=t.clone(),t.id=null),t.type||(t.type=a.itemType),t.portal||(t.portal=ne.getDefault()),k(a,t),t}function G(a){const e=[];return a.basemap&&e.push(a.basemap.load()),a.ground&&e.push(a.ground.load()),Promise.allSettled(e).then(()=>{})}async function x(a,e){e.extent=await ke(a.portalItem,a.initialViewProperties.viewpoint.targetGeometry),await Te(a,e)}const Se=b.JSAPI,B="CollectorDisabled",S="Collector",A="Data Editing",U="OfflineDisabled",O="Offline",F="Workforce Project",K="Workforce Worker",$="Workforce Dispatcher",Ae="Offline Map Areas",Oe="FieldMapsDisabled",P=b.DEVELOPER_BASEMAP,T="UtilityNetwork",W="IPS";async function Pe(a,e){l(e,B),l(e,Oe),l(e,b.METADATA),l(e,U),l(e,Ae),l(e,$),l(e,F),l(e,K),await x(a,e)}async function Te(a,e){f(e,Se),await We(a),Ce(a,e),De(a,e),Ve(a,e),Me(a,e),je(a,e),Le(a,e),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((t,o,r)=>r.indexOf(t)===o))}function We(a){const e=v(a).map(t=>t.load()).toArray();return Promise.allSettled(e).then(()=>{})}function v(a){return a.allLayers.concat(a.allTables)}function z(a){return v(a).some(e=>e.loaded&&C(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&(e.type!=="subtype-group"||e.sublayers.some(t=>t.editingEnabled)))}function Ee(a){return v(a).filter(e=>e.type!=="group").every(e=>e.loaded&&xe(a,e))}function Ce(a,e){h(e,B)||h(e,F)||h(e,K)||h(e,$)||!z(a)?l(e,S):f(e,S)}function De(a,e){z(a)?f(e,A):l(e,A)}function Ve(a,e){!h(e,U)&&Ee(a)?f(e,O):l(e,O)}function Me(a,e){we(a.basemap)?f(e,P):l(e,P)}function je(a,e){var t;(t=a.utilityNetworks)!=null&&t.length?f(e,T):l(e,T)}function Le(a,e){a.ipsInfo?f(e,W):l(e,W)}async function ke(a,e){const t=e.clone().normalize();let o;if(t.length>1)for(const r of t)o?r.width>o.width&&(o=r):o=r;else o=t[0];return Ne(a,o)}async function Ne(a,e){const t=e.spatialReference;if(t.isWGS84)return e.clone();if(t.isWebMercator)return ce(e);const{getGeometryServiceURL:o}=await E(()=>import("./geometryServiceUtils-DwLfpNW2.js"),__vite__mapDeps([3,1,2])),r=await o(a),s=new le({geometries:[e],outSpatialReference:pe.WGS84});return(await ue(r,s))[0]}function Ge(a){return de(a)||a.type==="map-notes"||a.type==="route"}function xe(a,e){return C(e)&&e.capabilities.operations.supportsSync||Ge(e)&&!e.portalItem||Be(e)&&!Ue(e)&&e.spatialReference.equals(a.initialViewProperties.spatialReference)}function Be(a){return(a.type==="tile"||a.type==="vector-tile")&&(a.capabilities.operations.supportsExportTiles||Fe(a)||he(a))}function Ue(a){return a.type==="vector-tile"&&Object.keys(a.sourceNameToSource).length>1}function Fe(a){return a.type==="tile"&&fe(a.url)&&_e.some(e=>{var t;return(t=a.url)==null?void 0:t.toLowerCase().includes("/"+e+"/")})}async function Ke(a,e,t,o,r){await t.update({data:o}),q(a,e,t,o,r)}async function $e(a,e,t,o,r,s){const i=e.portalItem,c={item:i,authenticated:!(!(i!=null&&i.id)||!i.portal.user)},u=t.portal;await u.signIn();const{copyAllowed:p,itemReloaded:m}=await H(c,u);if(c.authenticated||(c.authenticated=m),!p)throw new w(`${a.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const n=await J(t,c,o,s);return e.portalItem=t,q(a,e,t,o,r),n}async function H(a,e){var r;const{item:t,authenticated:o}=a;return t!=null&&t.id&&((r=t.typeKeywords)!=null&&r.includes("useOnly"))?t.portal.portalHostname!==e.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(o||await t.reload(),{copyAllowed:t.itemControl==="admin"||t.itemControl==="update",itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async function J(a,e,t,o){const r=a.portal,{item:s}=e,{folder:i,copyAllResources:c}=o;let u=!1;if(c&&(s!=null&&s.id)&&te(s.portal.url,r.url)&&parseInt(s.portal.currentVersion,10)>=2023){const{total:p}=await s.fetchResources();u=!!p}if(u){const p=await s.copy({copyResources:"all",folder:i});a.id=p.id,a.portal=p.portal;const m=a.toJSON();await a.load(),a.read(m),await a.update({data:t})}else await r.user.addItem({item:a,folder:i,data:t});return u}function q(a,e,t,o,r){se.prototype.read.call(e,{version:o.version,authoringApp:o.authoringApp,authoringAppVersion:o.authoringAppVersion},{origin:a.origin,ignoreDefaults:!0,url:t.itemUrl?ie(t.itemUrl):void 0}),me(r),e.resourceInfo=o}const Qe=Object.freeze(Object.defineProperty({__proto__:null,createJSON:I,initializeNewItem:J,isCopyAllowed:H,save:be,saveAs:Ie},Symbol.toStringTag,{value:"Module"}));export{Ze as n,M as p,Qe as w};
